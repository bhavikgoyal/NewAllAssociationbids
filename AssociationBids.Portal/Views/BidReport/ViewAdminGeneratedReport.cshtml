
@{
    ViewBag.Title = "View Bid Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string Errormessage = Convert.ToString(ViewData["Errormessage"]);
}

<h2>Bid Report</h2>
<style>
    .switch {
        position: relative;
        display: inline-block;
        width: 49px;
        height: 25px;
    }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: .4s;
        transition: .4s;
    }

        .slider:before {
            position: absolute;
            content: "";
            height: 15px;
            width: 15px;
            left: 2px;
            top: 5px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

    input:checked + .slider {
        background-color: #2196F3;
    }

    input:focus + .slider {
        box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
        -webkit-transform: translateX(26px);
        -ms-transform: translateX(26px);
        transform: translateX(26px);
    }

    /* Rounded sliders */
    .slider.round {
        border-radius: 34px;
    }

        .slider.round:before {
            border-radius: 50%;
        }
</style>
<script src="~/Content/themes/assets/js/vendors/jquery-3.2.1.min.js"></script>
<div class="app-content  my-3 my-md-5">
    <div class="side-app">
        <!-- page-header -->

        <div class="page-header">
            <ol class="breadcrumb">
                <!-- breadcrumb -->
                <li class="breadcrumb-item">@Html.ActionLink("Home", "Dashboard", "Dashboard", null, new { })</li>
                <li class="breadcrumb-item ">

                    @Html.ActionLink("Bid Report", "AdminBidReport", "BidReport", null, new { })
                </li>

                <li class="breadcrumb-item active text-left">Bid Report Details</li>

            </ol><!-- End breadcrumb -->

        </div>
        <!-- End page-header -->

        <div class="alert alert-success" id="success" style="display: none;margin-top: 20px;">
            <strong><span class="successmessages"></span></strong>
        </div>


        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div id="data">

                        </div>

                        <div class="row">
                            <div class="col-12">
                                <input type="hidden" class="bidvendorkey" id="bidvendorkey" value="" />
                                <p style="margin-top:20px; font-weight:bold"> <span style="color:red; font-size:15px;">*</span><span style="font-size:15px;color:black">COI Will Only Include In Email Report.</span></p>
                                <label> Detailed Report</label>
                                <label class="switch">

                                    <input type="checkbox" id="Detailed_Report" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label id="txtInclude_COI"> Include COI</label>
                                <label id="chkInclude_COI" class="switch">

                                    <input type="checkbox" id="Include_COI" checked>
                                    <span class="slider round"></span>
                                </label><br />
                                <button class="btn btn-md btn-success" id="EmailReport">Email Report</button>
                                <button class="btn btn-md btn-primary" id="DownloadReport">Download Report</button>
                                <a target="_blank" href="#" class="upd-f2" style="display: none;cursor: pointer; text-decoration: none;"></a> @*display:none;*@
                            </div>
                        </div>
                        <!-- end of form-div  -->
                    </div><!--end of card body -->
                </div>
            </div>
        </div>
    </div><!--End side app-->
    <!--footer-->
    <footer class="footer">
        <div class="container">
            <div class="row align-items-center flex-row-reverse">
                <div class="col-lg-12 col-sm-12   text-center">
                    Copyright © 2020 Association Bids. All rights reserved.
                </div>
            </div>
        </div>
    </footer>
    <!-- End Footer-->
</div>
<script type="text/javascript">
    var CblVendor = "";
    $(document).ready(function () {
        debugger;
        var val = '@ViewBag.BidRequestId';
        var RId = val.split(',');
        for (var i = 0; i < RId.length; i++)
        {
            var count = RId[i];
            BindVendor(count);
            //alert(count);
        }

    });
   $("#btnview").click(function () {
        debugger;
        //alert("Delete");
       window.location.href = 'ViewAdminGeneratedReport';

   });
    function BindVendor(BidRequestId) {
            debugger;
        //alert("bindserviceVendorKey " + a);
        $("#global-loader").show();
        var formData = new FormData();
        var a = BidRequestId;
        formData.append("BidRequestKey", a);
        formData.append("Modulekey", 100);
        //alert("Bind Service After FormData");
        debugger;

        $.ajax({
            type: 'POST',
            datatype: 'json',
            url: '@Url.Action("SearchVendorByBidRequest", "BidReport")',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {

                debugger;
                //alert(response.length);
                //$("#ServiceVendorViewp").show();
                //$("#btnaccept").attr("disabled", false);
                //$("#btnaccept").css("cursor", "pointer");
                if (response.length > 0) {
                    $('<div class="row">'
                        + '<div class= "col-12">'
                        + '<div class="card">'
                        + '<div class="card-header">'
                        + '<div class="col-md-4">'
                        + '<div class="form-group">'
                        + '<label class="form-label">Bid Title : <span>' + response[0].BidName + '</span></label>'
                        + '</div >'
                        + '</div >'
                        + '</div >'
                        + '<div class= "card-body border-top">'
                        + '<div class= "table-responsive" id = "ServiceVendorView' + BidRequestId + '">'
                        //+ '<div class= "table-responsive" id = "ServiceVendorView">'
                        + '<div class= "alert alert-danger" id = "Error1" style = "display:none; margin-top: 20px;" >'
                        + '<span class="errormessage1"></span>'
                        + '</div >'
                        //+ '<table id = "dataTableExample1' + BidRequestId + '" class= "table table-striped table-bordered text-nowrap w-100 dataTable no-footer" >'
                        + '<table id = "dataTableExample1" class= "table table-striped table-bordered text-nowrap w-100 dataTable no-footer" >'
                        + '<thead>'
                        + '<tr>'
                        + '<th width="15%" style="cursor: pointer;">Select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" class = "chk" id="Cbl_' + BidRequestId +'" checked /></th>'
                        + '<th>Vendor Name</th>'
                        + '<th>Response Due date</th>'
                        + '<th>Bid Amount</th>'
                        + '<th>Status</th>'
                        + '</tr>'
                        + '</thead>'
                        + '<tbody>'
                        + '<tr>'
                        + '<td style="text-align:center;"><span class="Cbl' + BidRequestId + '"></span></td>'
                        + '<td>'
                        + '    <span class="vVendorName' + BidRequestId + '"><i class="fa fa-star greentxt">Test Vendor</i></span>'
                        + '    <input type="hidden" class="bidvendorkey" id="bidvendorkey' + BidRequestId + '" value="" />'
                        + '</td>'
                        + '<td><span class="vResponseDueDate' + BidRequestId + '">03/05/2020</span></td>'
                        + '<td><span class="vBidAmount' + BidRequestId + '">$500</span></td>'
                        + '<td id="blue' + BidRequestId + '"><span class="badge badge-primary  mr-1 mb-1 mt-1 vStatus' + BidRequestId + '">Pending</span></td>'
                        + '<td id="red' + BidRequestId + '" ><span class="badge badge-danger   mr-1 mb-1 mt-1 vStatus' + BidRequestId + '">Pending</span></td>'
                        + '<td id="green' + BidRequestId + '" ><span class="badge badge-success  mr-1 mb-1 mt-1 vStatus' + BidRequestId + '">Pending</span></td>'
                        + '<td id="yellow' + BidRequestId + '" ><span class="badge badge-warning  mr-1 mb-1 mt-1 vStatus' + BidRequestId + '">Pending</span></td>'

                        + '</tr>'

                        + '</tbody>'
                        + '</table >'
                        + '</div >'
                        + '</div >'
                        + '</div >'
                        + '</div >'
                        + '</div >').appendTo("#data");

                    $("#ServiceVendorView" + BidRequestId + " table tbody tr:not(:first)").remove();
                    $("#ServiceVendorView" + BidRequestId + " table tbody tr:eq(0)").show();
                    //$("#dataTableExample1").find("tr:gt(0)").remove();

                    for (var i = 0; i < response.length; i++) {
                        debugger;



                        var cln = $("#ServiceVendorView" + BidRequestId + " table tbody tr:eq(0)").clone(true);
                        //alert("title = " + response[i].ServiceTitle);

                        $(".Cbl" + BidRequestId, cln).append('<input type="checkbox" id="Cbl_' + BidRequestId + '_' + response[i].BidVendorKey + '" checked />');
                        CblVendor += "Cbl_" + BidRequestId + "_" + response[i].BidVendorKey + ",";
                        //var container = document.getElementById('container');
                        //container.appendChild(checkbox);
                        $(".vVendorName" + BidRequestId, cln).html(response[i].Name);
                        var edit = '';
                        if (response[i].BidReqStatus == 'Interested' || response[i].BidReqStatus == 'In Progress')
                            edit = " <a class='pull-right font18' href='#' title= 'Edit Response Due Date' onclick='OpenPopupResponseDate(" + response[i].BidVendorKey + ")'>";
                        //alert(response[i].ResponseDueDates);
                        $(".vResponseDueDate" + BidRequestId, cln).html(response[i].ResponseDueDatess + edit);
                        $(".vBidAmount" + BidRequestId, cln).html(response[i].BidAmounts);

                        $(".vStatus" + BidRequestId, cln).html(response[i].BidReqStatus);
                        if (response[i].BidReqStatus == "Accepted" || response[i].BidReqStatus == "Submitted") {
                            $("#blue" + BidRequestId, cln).css("display", "none");
                            $("#red" + BidRequestId, cln).css("display", "none");
                            $("#yellow" + BidRequestId, cln).css("display", "none");
                            $("#green" + BidRequestId, cln).css("display", "block");

                        }
                        if (response[i].BidReqStatus == "In Progress") {
                            $("#blue" + BidRequestId, cln).css("display", "block");
                            $("#red" + BidRequestId, cln).css("display", "none");
                            $("#yellow" + BidRequestId, cln).css("display", "none");
                            $("#green" + BidRequestId, cln).css("display", "none");

                        }
                        if (response[i].BidReqStatus == "Rejected" || response[i].BidReqStatus == "Not Interested") {
                            $("#blue" + BidRequestId, cln).css("display", "none");
                            $("#red" + BidRequestId, cln).css("display", "block");
                            $("#yellow" + BidRequestId, cln).css("display", "none");
                            $("#green" + BidRequestId, cln).css("display", "none");

                        }
                        if (response[i].BidReqStatus == "Interested") {
                            $("#blue" + BidRequestId, cln).css("display", "none");
                            $("#red" + BidRequestId, cln).css("display", "none");
                            $("#yellow" + BidRequestId, cln).css("display", "block");
                            $("#green" + BidRequestId, cln).css("display", "none");

                        }
                        if (response[i].BidReqStatus == "Closed") {
                            $("#blue" + BidRequestId, cln).css("display", "block");
                            $("#red" + BidRequestId, cln).css("display", "none");
                            $("#yellow" + BidRequestId, cln).css("display", "none");
                            $("#green" + BidRequestId, cln).css("display", "none");

                        }

                        if (response[i].BidReqStatus == "Accepted" || response[i].BidReqStatus == "Rejected") {

                            $("#BidDueDateExpiredMessage").hide();
                        }
                        else {
                            $("#BidDueDateExpiredMessage").show();
                        }
                        $(".bidvendorkey" + BidRequestId, cln).val(response[i].BidVendorKey);

                        if ($("#BidReqStatus").val() == "In Progress" && response[i].IsAssigned == true) {
                            $(".deleteVendor", cln).show();
                            // $(".deleteVendor",cln).attr("onclick", "deletevendor(" + response[i].BidVendorKey + ")");
                        }
                        $("#viewreview", cln).show();
                        if (response[i].BidReqStatus == "Submitted" || response[i].BidReqStatus == "Accepted") {
                            $("#viewreview", cln).show();
                        }

                        if (response[i].BidReqStatus == "Accepted") {
                            $("#btncancel").hide();
                        }
                        else {
                            // $("#viewreview", cln).hide();

                        }
                        if (response[i].priority == '1' && response[i].BidVendorStatus != 'Cancelled') {
                            //if (response[i].priority == '1') {
                            $("#viewreview", cln).html('<i class="fa fa-bell animated faa-ring redtxt"></i>');
                        }

                        var descrip = response[i].Descrip;
                        var descrips = "";
                        var descripv = "";
                        var descrip3 = "";
                        descrips = descrip.replace(/"/g, "''");
                        //alert(descrips);
                        descripv = descrips.replace(/\n/g, "<br />");
                        //alert(descripv);
                        //descripv = descrips.replace(/,/g, " ");
                        //descrip3 = descripv.replace(/'/g, " ");
                        $("#viewreview", cln).attr('onclick', 'return openpopup("' + response[i].BidVendorKey + '","' + response[i].BidAmount + '","' + response[i].BidReqStatus + '","' + response[i].ResponseDueDates + '","' + descripv + '","' + response[i].NotificationType + '")');
                        $("#ServiceVendorView" + BidRequestId + " table").append(cln);
                    }
                    $("#ServiceVendorView" + BidRequestId + " table tbody tr:eq(0)").hide();

                    $("#bidvendorkey").val(CblVendor);
                    //alert($("#bidvendorkey").val());
                    $('#Cbl_' + BidRequestId).click(function () {
                        debugger;
                        
                        var val = CblVendor;
                        var RId = val.split(',');
                        var VId = "";

                        var ischecked = $(this).is(':checked');
                        if (!ischecked) {
                            for (var i = 0; i < RId.length; i++) {
                                var count = RId[i];
                                var count2 = RId[i].split('_', 2);
                                var count3 = count2[0] + "_" + count2[1];

                                if (count3 == $(this).attr("id")) {
                                    
                                    var ischecked = $("#" + count + "").is(':checked');
                                    if (!ischecked) {
                                        $("#" + count + "").prop('checked', false);
                                    }
                                    else {
                                        $("#" + count + "").prop('checked', false);
                                    }
                                }
                            }
                        }
                        else {

                            for (var i = 0; i < RId.length; i++) {
                                var count = RId[i];
                                var count2 = RId[i].split('_', 2);
                                var count3 = count2[0] + "_" + count2[1];

                                if (count3 == $(this).attr("id")) {
                                    
                                    var ischecked = $("#" + count + "").is(':checked');
                                    if (!ischecked) {
                                        $("#" + count + "").prop('checked', true);
                                    }
                                    else {
                                        $("#" + count + "").prop('checked', true);
                                    }
                                }
                            }
                        }
                    });
                    if (response.length == 0) {
                        $('.errormessage1').html('No vendors exists.');
                        $('#Error1').show();
                        $("#btnaccept").attr("disabled", true);
                        $("#btnaccept").css("cursor", "not-allowed");
                        $("#ServiceVendorView" + BidRequestId + " table thead tr:eq(0)").hide();
                        $("#ServiceVendorView" + BidRequestId + " table tbody tr:eq(0)").hide();
                    }
                    $("#global-loader").hide();

                }
            },
            error: function () {
                $("#global-loader").hide();
            }
        });
    }

    $("#Detailed_Report").change(function () {
        debugger;
        var ischecked = $(this).is(':checked');
        if (!ischecked) {
            $("#txtInclude_COI").hide();
            $("#chkInclude_COI").hide();
        }
        else
        {
            //$("#txtInclude_COI").hide();
            //$("#chkInclude_COI").hide();
            $("#txtInclude_COI").show();
            $("#chkInclude_COI").show();
        }
    });

    $("#EmailReport").click(function () {
        EmailReport("EmailReport");
        debugger;
        //alert("Delete");


    });
    $("#DownloadReport").click(function () {
        EmailReport("DownloadReport");
        debugger;
        //alert("Delete");


    });
    function EmailReport(ReportType)
    {
        debugger;
        var val = $("#bidvendorkey").val();
        var RId = val.split(',');
        var VId = "";
        for (var i = 0; i < RId.length -1; i++)
        {
            var count = RId[i];

            var ischecked = $("#" + count +"").is(':checked');
            if (!ischecked) {
                //$("#txtInclude_COI").hide();
                //$("#chkInclude_COI").hide();
            }
            else {
                VId += count+",";
            }
            //alert(count);
        }

        var formData = new FormData();
        var val = '@ViewBag.BidRequestId';
        //var a = BidRequestId;
        var ischecked = $("#Detailed_Report").is(':checked');
        var ReportType;
        if (!ischecked) {
            ReportTypeName = "SummaryReport";
        }
        else
        {
            ReportTypeName = "DetailReport";
        }
        formData.append("BidRequestKey", val);
        formData.append("VendorSelected", VId);
        formData.append("Modulekey", 100);
        
        formData.append("ReportTypeName", ReportTypeName);
        formData.append("ReportType", ReportType);
        var ischeckeds = $("#Include_COI").is(':checked');
        if (!ischeckeds) {
            formData.append("Include_COI", false);
        }
        else {
            formData.append("Include_COI", true);
        }
        
        //alert("Bind Service After FormData");
        debugger;

        $.ajax({
            type: 'POST',
            datatype: 'json',
            url: '@Url.Action("DownloadEmail", "BidReport")',
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                debugger;
                //alert(response);
                //alert(response[0]);
                if (response.length > 0) {
                    $(".upd-f2").attr('src', + response[0]);
                    $(".upd-f2").attr('href', response[0]);
                    $(".upd-f2").attr('onclick', "download('" + response[0] + "')");
                    $(".upd-f2").html(response);
                    /*$(".upd-f2").click();*/
                    //$('.upd-f2')[0].click();
                    window.location = response[0];
                    //var url = $(".upd-f2").attr('href');
                    //window.open(url);
                    //if (ReportType == "EmailReport") {
                    //    $('.successmessages').html('Email Sent in sometimes.');
                    //    $('#success').show();
                    //}
                }
                else
                {
                    //if (ReportType == "EmailReport")
                    //{
                    $('.successmessages').html('Email Sent in sometimes.');
                    $('#success').show();
                    $(window).scrollTop(0);
                    //}
                }
            },
            error: function () {
                $("#global-loader").hide();
            }
        });
    }
    function download(src) {
        //alert(src);
        debugger;
        var strWindowFeatures = "location=yes,height=570,width=520,scrollbars=yes,status=yes";
        window.open(src, "_blank", strWindowFeatures);
    }
</script>