<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
@{
    ViewBag.Title = "BillingList";
    Layout = "~/Views/Shared/_VendorLayout.cshtml";
    string Errormessage = Convert.ToString(ViewData["Errormessage"]);
}

<h2>Billing List</h2>

<script src="~/Content/themes/assets/js/vendors/jquery-3.2.1.min.js"></script>
<style type="text/css">
    .noti-alert {
        position: absolute !important;
        top: 0;
        width: 100%;
        left: 0;
        padding:0 !important;
        margin:0 !important;
        padding-left: 3%;
    }
    .noticlose {
        cursor: pointer !important;
        float:right !important;
    }
</style>

    <!-- app-content-->
<div class="app-content  my-3 my-md-5">
    <div class="side-app">

        <!-- page-header -->
        <div class="page-header">
            <ol class="breadcrumb">
                <!-- breadcrumb -->
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Billing</li>
            </ol><!-- End breadcrumb -->

        </div>

        @if (TempData["Sucessmessage"] != null)
        {
        <p class="alert alert-success alert-dismissible" id="successMessage">
            @TempData["Sucessmessage"]
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        </p>
        }
        @if (TempData["delete"] != null)
        {
        <p class="alert alert-danger alert-dismissible" id="successMessage">
            @TempData["delete"]
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
        </p>
        }

        <div role="alert">
            <div class="alert alert-danger" id="Error" style="display: none;margin-top: 20px;">
                <strong><span class="errormessage"></span></strong>
            </div>
            @if (!string.IsNullOrEmpty(Errormessage))
            {
            <div class="alert alert-danger" style="margin-top: 20px;">
                <strong><span>@Errormessage</span></strong>
            </div>
            }
        </div>

        <!-- End page-header -->

        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-12 grid-margin stretch-card">
                        <div class="card">
                            <div class="card-body">
                                <div class="row" id="DivSec">
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-12 grid-margin stretch-card">
                                                <div class="card cc-card-box">
                                                    <div class="card-body">

                                                        <div class="cc-card-div">
                                                            <p class="text-center">
                                                                <a href="vBillingAdd">
                                                                    <span class="icon"><img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBpZD0iQ3JlZGl0X2NhcmQiIGRhdGEtbmFtZT0iQ3JlZGl0IGNhcmQiIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEycHgiIGhlaWdodD0iNTEycHgiPjxwYXRoIGQ9Ik00NDAsMjg5LjYxVjE0NGE0MC4wNDUsNDAuMDQ1LDAsMCwwLTQwLTQwSDQ4QTQwLjA0NSw0MC4wNDUsMCwwLDAsOCwxNDRWMzM2YTQwLjA0NSw0MC4wNDUsMCwwLDAsNDAsNDBIMzQ0LjRBODAsODAsMCwxLDAsNDQwLDI4OS42MVpNMjQsMTYwSDQyNHYzMkgyNFptMjQtNDBINDAwYTI0LjAyNywyNC4wMjcsMCwwLDEsMjQsMjRIMjRBMjQuMDI3LDI0LjAyNywwLDAsMSw0OCwxMjBaTTI0LDMzNlYyMDhINDI0djgwYTgwLjExLDgwLjExLDAsMCwwLTc5LjYsNzJINDhBMjQuMDI3LDI0LjAyNywwLDAsMSwyNCwzMzZabTQwMCw5NmE2NCw2NCwwLDEsMSw2NC02NEE2NC4wNzIsNjQuMDcyLDAsMCwxLDQyNCw0MzJaIiBmaWxsPSIjMDAwMDAwIi8+PHBhdGggZD0iTTEzNiwyMjRINDhhOCw4LDAsMCwwLTgsOHY0MGE4LDgsMCwwLDAsOCw4aDg4YTgsOCwwLDAsMCw4LThWMjMyQTgsOCwwLDAsMCwxMzYsMjI0Wm0tOCw0MEg1NlYyNDBoNzJaIiBmaWxsPSIjMDAwMDAwIi8+PHBhdGggZD0iTTEzNiwyODhINDhhOCw4LDAsMCwwLDAsMTZoODhhOCw4LDAsMCwwLDAtMTZaIiBmaWxsPSIjMDAwMDAwIi8+PHBhdGggZD0iTTg4LDMxMkg0OGE4LDgsMCwwLDAsMCwxNkg4OGE4LDgsMCwwLDAsMC0xNloiIGZpbGw9IiMwMDAwMDAiLz48cGF0aCBkPSJNMTIwLDMxMmgtOGE4LDgsMCwwLDAsMCwxNmg4YTgsOCwwLDAsMCwwLTE2WiIgZmlsbD0iIzAwMDAwMCIvPjxwYXRoIGQ9Ik00NDgsMzYwSDQzMlYzNDRhOCw4LDAsMCwwLTE2LDB2MTZINDAwYTgsOCwwLDAsMCwwLDE2aDE2djE2YTgsOCwwLDAsMCwxNiwwVjM3NmgxNmE4LDgsMCwwLDAsMC0xNloiIGZpbGw9IiMwMDAwMDAiLz48L3N2Zz4K" style="max-width: 28px;max-height: 28px;" /></span>
                                                                    Add Payment Method
                                                                </a>
                                                            </p>
                                                        </div><!-- end of cc-card-div-->

                                                    </div><!-- end of card body -->

                                                </div><!-- end of card -->
                                            </div><!-- end of col -->
                                        </div><!-- end of row -->


                                    </div><!-- end of col -->

                                </div><!-- end of row-->
                            </div><!-- end of card body -->
                        </div><!-- end of card -->
                    </div><!-- end of col -->
                </div><!-- end of row -->
            </div><!-- end of col -->
        </div><!-- end of row -->
    </div><!--End side app-->
   
    <!--footer-->
    <footer class="footer">
        <div class="container">
            <div class="row align-items-center flex-row-reverse">
                <div class="col-lg-12 col-sm-12   text-center">
                    Copyright © 2020 Association Bids. All rights reserved.
                </div>
            </div>
        </div>
    </footer>
    <!-- End Footer-->
</div>
    <!-- End app-content-->


<!-- Jquery js-->
<script src="~/Content/themes/assets/js/vendors/jquery-3.2.1.min.js"></script>

<script type="text/javascript">
    $(document).ready(function ()
    {
        $("#Error").hide();

        LoadPaymentMethodList();
        
        $("#global-loader").hide();
    });

    function LoadPaymentMethodList() {
        $.ajax({
            url: '@Url.Action("LoadBillingList", "vBilling")',
            cache: false,
            success: function (response) {

                if (parseInt(response.length) > 0) {
                    var strCCData = '';
                    for (var i = 0; i < response.length; i++) {

                        var SpecialChar = "";
                        if (response[i].MaskedCCNumber !== "") {
                            const id = response[i].MaskedCCNumber;
                            var fourlastchar = id.substr(id.length - 4);
                            SpecialChar = 'XXXX XXXX XXXX ' + fourlastchar;
                        }
                        debugger;
                        var alertText = "";
                        if (response[i].priority == '1') {
                            if (response[i].NotificationType == "CCExpiry") {
                                alertText = '<i class="alert alert-warning noti-alert"><i class="fa fa-info-circle" ></i> Your Credit Card is about to Expire. <i class="fe fe-x-circle noticlose " onclick="notificationClick(' + response[i].NotificationId + ',\'' + response[i].NotificationType + '\',this)"></i></i>';
                            }
                            else if (response[i].NotificationType == "CCExpired") {
                                alertText = '<i class="alert alert-danger noti-alert"><i class="fa fa-info-circle" ></i> Your Credit Card is Expired. <i class="fe fe-x-circle noticlose" onclick="notificationClick(' + response[i].NotificationId + ',\'' + response[i].NotificationType + '\',this)"></i></i>';
                            }
                        }
                        strCCData = strCCData + '<div class="col-md-6"><div class="row"><div class="col-md-12 grid-margin stretch-card"><div class="card"><div class="card-body"> '+alertText+' <div class="cc-card-div">';
                        strCCData = strCCData + '<h5 class="MaskedCCNumber" style="font-size: 2rem;">' + SpecialChar + '</h5><p class="Expires">' + response[i].CardHolderFirstName + '&nbsp;' + response[i].CardHolderLastName + '</p> ';//'<span class="text-right"> ' + response[i].ValidTillMM + '/' + response[i].ValidTillYY + '</span>
                        strCCData = strCCData + '</div></div><div class="card-footer"><div class="row">';
                        if (response[i].PrimaryMethod == 1) {
                            strCCData = strCCData + '<div class="col-md-6"><p class="PrimaryMethod">Primary</p></div>';
                        }
                        else {
                            strCCData = strCCData + '<div class="col-md-6"><p class="PrimaryMethod">Secondary</p></div>';
                            strCCData += '<div class="col-md-6"><a onclick = "DeleteFun(' + response[i].PaymentMethodKey + ')"  class="btn btn-danger pull-right text-white" id = "btnDelete" title = "Delete" > ';
                            strCCData = strCCData + '<i class="fe fe-trash"  ></i></a>';
                            strCCData = strCCData + '<a onclick="update(' + response[i].PaymentMethodKey + ')" class="btn btn-primary pull-right text-white" style = "margin-right:8px;" title = "Make Payment Method as Primary">Make Primary</a> </div>';

                        }
                        strCCData = strCCData + '</div></div></div></div></div></div>';

                        //
                        //var div = $("#DivSec").clone(true);
                        //$(".MaskedCCNumber", div).html(response[i].MaskedCCNumber);
                        //$("#viewdata", div).attr('href', '/NewPricing/NewPricingView?PricingKey=' + response[i].PricingKey);
                        //$("#DivSecPar div").append(div);
                    }

                    var divOriVal = $("#DivSec").html();
                    $("#DivSec").html(strCCData + divOriVal);
                }
            }
        }); 
    }

    function DeleteFun(PaymentMethodKey) {
        debugger;

        if (confirm('Are you sure you want to delete this record?')) {
            window.location.href = 'Delete?PaymentMethodKey=' + PaymentMethodKey;
            return true;
        }
        else {
            return false;
        }
    }
    function update(pmKey) {
        $("#Error").hide();
        if (confirm('Are you sure you want to Make this Method as Primary?')) {
            $("#global-loader").show();
            $.ajax({
                url: '@Url.Action("UpdatePM","vBilling")',
                data: {
                    PaymentMethodKey: pmKey
                },
                type: "Post",
                cache: false,
                success: function (response) {
                    debugger;
                    if (response == true) {
                        window.location.reload(true);
                    }
                    else {
                        $("#global-loader").hide();
                        $("#Error").show(200);
                        $(".errormessage").html("Something went wrong.");
                    }
                },
                error: function (response) {
                    $("#global-loader").hide();
                    $("#Error").show(200);
                    $(".errormessage").html("Something went wrong.");
                }
            });
        }
        else {
            return false;
        }
    }
    function notificationClick(nid, type,me) {
        debugger;
        $.ajax({
            url: '/ABNotification/NotificationUpdate',
            cache: false,
            data: {
                NotiId: nid,
                Status: 'read',
                NotiType: type
            },
            success: function (response) {
                if (response == 'true' || response == true) {
                    debugger;
                    $(me.parentNode).hide(2000, function () {
                        $(me.parentNode).remove();
                    });
                    $(".header-notify").load("/ABNotification/Notification");
                }
            }
        });
    }
</script>
